# Идея

Сделать валентинку в виде печатной платы с микроконтроллером и светодиодами. Должна работать от
часовой батарейки. Основные пункты:

* должна быть дешевой;
* должно быть минимум компонентов (см. предыдущий пункт);
* должна быть низкопотребляющей;
* все компоненты, кроме светодиодов и кнопки, должны быть на обратной стороне платы.

Эскиз на рисунке ниже:

<figure style="text-align: center">
	<img src="_static\sketch.png" alt="sketch">
	<figcaption style="text-align: center">Эскиз устройства</figcaption>
</figure>

# Выбор светодиодов

Основные варианты:

* Обычные светодиоды, например, [TO-1608BC-MRE](https://www.chipdip.ru/product/to-1608bc-mre-svetodiod-krasnyy-smd-1608-112mkd-oasistek-9000414317):

    * (+) дешево
    * (+) энергоэффективно
    * (-) нужно много ног для управления
    * (-) сердито
    * Параметры:

        * Прямой ток 25 мА;
        * Прямое напряжение 2 В.


* Адресный, например, [SK(C)6812-RGBW-BW](https://www.chipdip.ru/product/sk-c-6812-rgbw-bw-neopixel-svetodiod-shenzhen-shiningled-9000373823):

    * (+) красиво, много режимов
    * (+) всего 2 провода для управления
    * (-) скорее всего будет больше жрать, хотя как запрограммировать
    * (-) борьба с наводками???
    * (-) дороже
    * Параметры:

        * Напряжение питания 3.7-5.5 В
        * Прямой ток 20-30 мА на один цвет.

# Оценка потребления

Выбираются 14 светодиодов TO-1608BC-MRE. Ток ограничивается до 15 мА через резистор. Режимы:

1. Один светодиод в единицу времени;
2. Все светодиоды разом (худший случай).

Для первого режима потребление по светодиодам 15 мА. Для второго - 15 * 14 = 210 мА.

Пусть будет _какая-то_ батарейка на 100 мАч (см. [таблицу](https://mosclock.ru/clock/o-garantii/zamena-batareek/tablitsa-sravneniya-chasovykh-batareek/?srsltid=AfmBOorHNBOLRriNnmurLrfbC0cLY0ivmhHh0GXlCDRKjwAtHPy7bsK3)). Тогда 

1. 100 / 15 ~= 6 ч на одни только светодиоды;
2. 100 / 210 ~= 0.5 ч на одни только светодиоды.

# Выбор микроконтроллера

Судя по всему, это будет STM32L0. Варианты:

1. [STM32L011F3P6](https://www.chipdip.ru/product/stm32l011f3p6-st-microelectronics-8003145100)
2. [STM32L010F4P6](https://www.chipdip.ru/product/stm32l010f4p6-mikrokontroller-arm-st-microelectronics-9001089803)

Почему STM:

* знаю, что там точно есть режимы с супер низким потреблением;
* знакомая платформа;
* не нужно будет докупать программатор, т.к. он есть.

Вариант 1:

* Корпус: TSSOP-20
* GPIO: 11-15 (зависит от того, что смогу сконфигурировать)
* Напряжение питания от 1.65 до 3.6 В.
* Тактирование от внутренней RC-цепочки.

Вариант 2 не рассматривается, т.к. 1-й вариант более чем устраивает.

# Что говорит ИИ?

* [Ответ 1](https://share.google/aimode/JZRhZsYDs94hqZSMV).
* [Ответ 2](https://share.google/aimode/ylKgjJaCaAhDsedJH).

# Выбор батарейки

Судя по всему, подходит [CR2032](https://www.dart.ru/cataloguenew/others/accumulator/html/cr2032.shtml).
Характеристики:

* выходное напряжение 3 В;
* выходной ток  0.4 мА;
* мощность 210 мА/ч.

# Блок-схема устройства

<figure style="text-align: center">
	<img src="_static\block-diagram.png" alt="diagram">
	<figcaption style="text-align: center">Блок-схема устройства</figcaption>
</figure>

# Попытка рассчитать буферный конденсатор

Потребляемая мощность:

$$ P = P_{mc} + P_d $$

где $P_{mc}$ - мощность, потребляемая МК, $P_d$ - мощность, рассеиваемая при зажигании одного
светодиода.

Требуется определить количество энергии, которое будет потреблено за 1 секунду. Оцениваем мощности:

* $ P_d = I^2 \cdot R = 0.015^2 \cdot 120 = 0.027 $ Вт;
* $ P_{mc} = 3 \cdot 0.0005 = 0.0015 $ Вт (грубая оценка, судя по всему не должно превышать этого значения, см.
"Table 22. Current consumption in Run mode, code with data processing running from Flash" для MSI
clock).

Тогда

$$ E = (0.027 + 0.0015) \cdot 1 = 0.0285\ Дж $$

Энергия конденсатора определяется выражением:

$$ E_c = {CU^2 \over 2} $$

Определяем разницу энергий - до включения светодиода и после выключения. Допустим, что напряжение
$U_{low}$ может упасть до 2 В. Эта разница - та энергия, которая уходит на микроконтроллер и на
горение светодиода. Тогда ёмкость:

$$ C = {2E \over U_0^2 - U_{low}^2} = {2 \cdot 0.0285 \over 3^2 - 2^2} = 0.0114\ Ф = 11400\ мкФ $$

Это при условии, что светодиод будет постоянно гореть, а микроконтроллер не будет переводиться в
низкопотребляющие режимы.

Пусть светодиод будет гореть 5% от всего времени, тогда $P_d = 0.027 \cdot 0.05 = 0.00135\ Вт$.
Тогда ёмкость:

$$ C = {2 \cdot (0.0015 + 0.00135) \over 3^2 - 2^2} = 1140\ мкФ$$

# Схема электрическая принципиальная

<figure style="text-align: center">
	<img src="_static\schematic.png" alt="sketch">
	<figcaption style="text-align: center">Схема электрическая принципиальная</figcaption>
</figure>

# Алгоритм сборки

* Пайка резисторов для светодиодов на нижней стороне платы: флюс, паста, установить резисторы,
  прогреть феном. После операции проверить мультиметром пайку (у каждого резистора есть переходное
  отверстие, использовать его и КП микроконтроллера).
  **Внимание!** R12 и R11 не запаивать!
* Пайка светодиодов на верхней стороне платы: флюс, паста, установить светодиоды, прогреть феном.
  После операции проверить мультиметром пайку (у каждого светодиода есть переходное отверстие,
  использовать его и землю).
* Пайка микроконтроллера: флюс, запаять паяльником краевые выводы. Затем движениями от МК до конца
  площадки нанести припой. После пайки проверить все линии. Проверить, нет ли КЗ по всем линиям.
* Запаять R15.
* Пайка кнопки. Кнопка размещается с верхней стороны. После установки в посадочное место обрезать
  выводы с другой стороны и запаять.
* Прошить МК прошивкой с флагом DEBUG, убедиться, что все ок.
* Прошить МК прошивкой без флага DEBUG.
* Запаять R12 и R11.
* Пайка конденсаторов (вывод с полосой - gnd). ~~Предположительно хватит 2-х конденсаторов~~
  Поставил все 3. Конденсаторы - с нижней стороны. После установки в посадочное   место обрезать
  выводы с другой стороны и запаять.
* Отчистить плату.
* Запаять отсек для батарейки и включить устройство.
* Зашкурить

# Итоговое потребление

* STATE_START: 380 мА (ничего не мигает)
* STATE_RUNNING_LED: 850 мА
* STATE_SYMMETRY_RUNNING_LED: 880 мА

Просадок напряжения питания осциллографом не увидел.

# Что можно улучшить?

## Конструктивно

* Вывести площадку с NRST, чтобы можно было не бояться закирпичить устройство.
* Добавить запаиваемую перемычку после R15, чтобы можно было более удобно измерять силу тока.
* Не забыть шелкографию при производстве плат))0))
* Выбрать какие-то другие светодиоды. Паять эти - сущий ад.

  * Возможно имеет смысл поставить низкопотребляющие светодиоды.

* Сделать площадки светодиодов и резисторов побольше чуть-чуть.
* Исправить УГО J1 - сейчас шаг маленький, не могу поставить стандартный PLS.
* Конденсатор после кнопки для фильтрации дребезга.
* Поставить запаиваемые перемычки на линиях LED10 и LED11, чтобы можно было паять сразу все резисторы. Тогда проблем с прошивкой быть не должно.

## Программно

* Улучшить реализацию фильтра дребезга.
* Добавить больше режимов.
* Поддержать Stop и Standby режимы.
* Более тонко понастраивать потребление через задержки.
* Использовать LSI вместо HSI16.

# Итоги

* Устройство заработало.

<figure style="text-align: center">
	<img src="_static\result-front.png" alt="sketch">
	<figcaption style="text-align: center">Результат. Передняя сторона</figcaption>
</figure>

<figure style="text-align: center">
	<img src="_static\result-back.png" alt="sketch">
	<figcaption style="text-align: center">Результат. Задняя сторона</figcaption>
</figure>

<figure style="text-align: center">
	<img src="_static\result.gif" alt="sketch">
	<figcaption style="text-align: center">Результат в действии</figcaption>
</figure>

* Дешевым проект не назову - платы дорого вышли. Но делал срочный заказ, чтобы успеть к сроку, так
  что пойдет.

* Требование по низкому потреблению выдержано, можно улучшить.

# Для справки

* Светодиоды с низким током потребления:

    * [led smd 1ma](https://www.chipdip.ru/search?searchtext=led+smd+1ma)
    * [VLMA3100-GS08](https://www.chipdip.ru/product/vlma3100-gs08-led-yellow-smd-plcc-2-2-ma-2.2-v-594-vishay-8733971327)

# Полезные ссылки

* [Basics of power supply design for MCU](https://wiki.st.com/stm32mcu/wiki/Basics_of_power_supply_design_for_MCU)
* [Краткое руководство KiCad](https://docs.kicad.org/5.1/ru/getting_started_in_kicad/getting_started_in_kicad.html)
* [Ultra Low Power LED Flasher using the Padauk PFS154](https://cpldcpu.com/2021/02/07/ultra-low-power-led-flasher/)
* [Про буферные конденсаторы](https://habr.com/ru/articles/671232/)
